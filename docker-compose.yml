version : '3'

services:
  apache:
#    image: httpd:latest
    build: ./docker-build/custom-httpd
    depends_on:
      - tomcat
    ports:
      - "80:80"
    volumes:
      - "./docker-conf/custom-httpd/docker-proxy.conf:/usr/local/apache2/conf.d/docker-proxy.conf"
    networks:
      - frontend
    links:
      - tomcat

  # MySQL database shared with tomcat containers.
  tomcat:
#    image: tomcat:latest
    build: ./docker-build/custom-tomcat
    # Environment variables do not appear to be getting loaded the first time Tomcat starts!
    environment: 
      JDBC_URL: jdbc:mariadb://mariadb:3306/jpetstore?connectTimeout=0&amp;socketTimeout=0&amp;autoReconnect=true
      JDBC_USER: jpetstore
      JDBC_PASS: jpetstore
    networks:
      - frontend
      - backend
    volumes:
      - "./docker-apps/webapps/sample:/usr/local/tomcat/webapps/sample"
      - "./docker-apps/webapps/jpetstore:/usr/local/tomcat/webapps/jpetstore"
    links:
      - mariadb
      
  # MySQL database shared with tomcat containers.
  mariadb:
    image: mariadb:latest
#    build: ./docker-build/custom-mariadb
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword1234
      MYSQL_DATABASE: jpetstore
      MYSQL_USER: jpetstore
      MYSQL_PASSWORD: jpetstore
    networks:
      - backend
    volumes:
      - "./docker-data/db-init:/docker-entrypoint-initdb.d"
      - "./docker-data/db-data:/var/lib/mysql"
      - "./docker-logs/db-log:/var/log/mysql"

# network layer
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
